"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.sign = void 0;
const wallet_api_core_1 = require("@ledgerhq/wallet-api-core");
const rxjs_1 = require("rxjs");
const sign = async (req, context, handlers) => {
    const walletHandler = handlers["message.sign"];
    if (!walletHandler) {
        throw new wallet_api_core_1.ServerError((0, wallet_api_core_1.createNotImplementedByWallet)("message.sign"));
    }
    const safeParams = wallet_api_core_1.schemaMessageSign.params.parse(req.params);
    const accounts = await (0, rxjs_1.firstValueFrom)(context.accounts$);
    const { accountId, hexMessage } = safeParams;
    const account = accounts.find((acc) => acc.id === accountId);
    if (!account) {
        throw new wallet_api_core_1.ServerError((0, wallet_api_core_1.createAccountNotFound)(accountId));
    }
    const signedMessage = await walletHandler({
        account,
        message: Buffer.from(hexMessage, "hex"),
    });
    return {
        hexSignedMessage: signedMessage.toString("hex"),
    };
};
exports.sign = sign;
